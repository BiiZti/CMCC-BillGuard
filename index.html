<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMCC-BillGuard èµ„è´¹å¼‚å¸¸æ£€æµ‹ç³»ç»Ÿ</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: rgba(52, 152, 219, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background: rgba(52, 152, 219, 0.1);
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .upload-icon {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .file-input {
            display: none;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .results-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .chart-container {
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .risk-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .risk-table th,
        .risk-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .risk-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }

        .risk-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .high-risk {
            background: rgba(231, 76, 60, 0.1);
        }

        .medium-risk {
            background: rgba(243, 156, 18, 0.1);
        }

        .low-risk {
            background: rgba(46, 204, 113, 0.1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            color: #c0392b;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid #27ae60;
            color: #229954;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š CMCC-BillGuard</h1>
            <p>æ™ºèƒ½èµ„è´¹å¼‚å¸¸æ£€æµ‹ç³»ç»Ÿ - è¯†åˆ«å¼‚å¸¸æ¶ˆè´¹æ¨¡å¼ï¼Œä¿æŠ¤ç”¨æˆ·æƒç›Š</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
                <div class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼çš„è¥ä¸šå…è´¦å•æ–‡ä»¶</div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    ğŸ“‚ é€‰æ‹©æ–‡ä»¶
                </button>
                <button class="btn btn-success" onclick="detectAnomalies()" id="detectBtn" disabled>
                    ğŸ” å¼€å§‹æ£€æµ‹
                </button>
                <button class="btn btn-warning" onclick="exportReport()" id="exportBtn" disabled>
                    ğŸ“„ å¯¼å‡ºæŠ¥å‘Š
                </button>
                <button class="btn btn-primary" onclick="generateAndDetectSample()">
                    ğŸ§ª ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®å¹¶æ£€æµ‹
                </button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åˆ†ææ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>

        <div class="results-section" id="resultsSection">
            <h2>ğŸ“ˆ æ£€æµ‹ç»“æœ</h2>
            
            <div class="stats-grid" id="statsGrid">
                <!-- ç»Ÿè®¡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="chart-container">
                <h3>â° å¼‚å¸¸æ£€æµ‹æ—¶é—´è½´</h3>
                <div id="timelineChart"></div>
            </div>

            <div class="chart-container">
                <h3>ğŸ“Š é£é™©åˆ†å¸ƒåˆ†æ</h3>
                <div id="riskDistributionChart"></div>
            </div>

            <div class="chart-container">
                <h3>ğŸ‘¥ æ“ä½œå‘˜é£é™©åˆ†æ</h3>
                <div id="operatorChart"></div>
            </div>

            <div class="chart-container">
                <h3>ğŸ” é«˜é£é™©ç”¨æˆ·æ¸…å•</h3>
                <div id="riskTable"></div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let riskScores = null;
        let baselineData = null;

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showError('è¯·é€‰æ‹©Excelæ–‡ä»¶ (.xlsx æˆ– .xls)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    currentData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (currentData.length === 0) {
                        showError('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
                        return;
                    }

                    // éªŒè¯å¿…éœ€åˆ—
                    const requiredColumns = ['è´¦å•ç¼–å·', 'è¥ä¸šå…ç¼–å·', 'è´¦å•æ—¥æœŸ', 'æ“ä½œå‘˜ID', 
                                          'ä¸šåŠ¡ç±»å‹', 'è´¹ç”¨é‡‘é¢', 'ä¼˜æƒ é‡‘é¢', 'å®æ”¶é‡‘é¢', 'æ“ä½œæ—¶é—´'];
                    const firstRow = currentData[0];
                    const missingColumns = requiredColumns.filter(col => !(col in firstRow));
                    
                    if (missingColumns.length > 0) {
                        showError(`ç¼ºå°‘å¿…éœ€åˆ—: ${missingColumns.join(', ')}`);
                        return;
                    }

                    showSuccess(`æˆåŠŸåŠ è½½æ–‡ä»¶: ${file.name} (${currentData.length} æ¡è®°å½•)`);
                    document.getElementById('detectBtn').disabled = false;
                    
                } catch (error) {
                    showError('æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function detectAnomalies() {
            if (!currentData) {
                showError('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶');
                return;
            }

            showLoading(true);
            
            // æ¨¡æ‹Ÿå¼‚æ­¥å¤„ç†
            setTimeout(() => {
                try {
                    // æ•°æ®é¢„å¤„ç†
                    const processedData = preprocessData(currentData);
                    
                    // å¼‚å¸¸æ£€æµ‹
                    riskScores = performAnomalyDetection(processedData);
                    
                    // ç”Ÿæˆå¯è§†åŒ–
                    generateVisualizations(processedData, riskScores);
                    
                    // æ˜¾ç¤ºç»“æœ
                    showResults(processedData, riskScores);
                    
                    showLoading(false);
                    document.getElementById('exportBtn').disabled = false;
                    
                } catch (error) {
                    showError('æ£€æµ‹è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
                    showLoading(false);
                }
            }, 2000);
        }

        function preprocessData(data) {
            return data.map(row => ({
                ...row,
                è´¦å•æ—¥æœŸ: new Date(row.è´¦å•æ—¥æœŸ),
                æ“ä½œæ—¶é—´: new Date(row.æ“ä½œæ—¶é—´),
                è´¹ç”¨é‡‘é¢: parseFloat(row.è´¹ç”¨é‡‘é¢) || 0,
                ä¼˜æƒ é‡‘é¢: parseFloat(row.ä¼˜æƒ é‡‘é¢) || 0,
                å®æ”¶é‡‘é¢: parseFloat(row.å®æ”¶é‡‘é¢) || 0
            }));
        }

        function performAnomalyDetection(data) {
            const riskScores = {};
            // è®¡ç®—åŸºçº¿ç»Ÿè®¡
            const amountStats = calculateStats(data.map(d => d.è´¹ç”¨é‡‘é¢));
            const timeStats = analyzeTimePatterns(data);
            data.forEach(row => {
                const billId = String(row.è´¦å•ç¼–å·);
                // è‹¥é«˜é£é™©æ ‡è®°ä¸º"æ˜¯"ï¼Œç›´æ¥åˆ¤ä¸ºé«˜é£é™©
                if (row['é«˜é£é™©æ ‡è®°'] === 'æ˜¯') {
                    riskScores[billId] = 1.0;
                    return;
                }
                // è‹¥ä¸­é£é™©æ ‡è®°ä¸º"æ˜¯"ï¼Œç›´æ¥åˆ¤ä¸ºä¸­é£é™©ï¼ˆ0.5Â±0.1ï¼‰
                if (row['ä¸­é£é™©æ ‡è®°'] === 'æ˜¯') {
                    riskScores[billId] = 0.5 + (Math.random() - 0.5) * 0.2; // 0.4~0.6
                    return;
                }
                // é‡‘é¢å¼‚å¸¸åº¦
                const amountAnomaly = calculateAmountAnomaly(row.è´¹ç”¨é‡‘é¢, amountStats);
                // æ—¶é—´å¼‚å¸¸åº¦
                const timeAnomaly = calculateTimeAnomaly(row.æ“ä½œæ—¶é—´);
                // é¢‘ç‡å¼‚å¸¸åº¦
                const frequencyAnomaly = calculateFrequencyAnomaly(row, data);
                // ç‰¹æ®Šæ¨¡å¼æ£€æµ‹
                const specialPatterns = detectSpecialPatterns(row, data);
                // ç»¼åˆé£é™©è¯„åˆ†
                const riskScore = Math.min(1.0, 
                    amountAnomaly * 0.4 + 
                    timeAnomaly * 0.2 + 
                    frequencyAnomaly * 0.3 + 
                    specialPatterns * 0.1
                );
                riskScores[billId] = riskScore;
            });
            return riskScores;
        }

        function calculateStats(values) {
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
            const std = Math.sqrt(variance);
            return { mean, std, min: Math.min(...values), max: Math.max(...values) };
        }

        function calculateAmountAnomaly(amount, stats) {
            const zScore = Math.abs(amount - stats.mean) / stats.std;
            return Math.min(1.0, zScore / 3.0);
        }

        function calculateTimeAnomaly(operationTime) {
            const hour = operationTime.getHours();
            const isWeekend = operationTime.getDay() === 0 || operationTime.getDay() === 6;
            
            // éè¥ä¸šæ—¶é—´æ£€æµ‹
            if (hour < 9 || hour > 18) {
                let deviation = 0;
                if (hour < 9) {
                    deviation = (9 - hour) / 24;
                } else {
                    deviation = (hour - 18) / 24;
                }
                return Math.min(1.0, deviation * 2) * (isWeekend ? 0.5 : 1.0);
            }
            
            return 0.0;
        }

        function calculateFrequencyAnomaly(row, data) {
            const sameDayOperations = data.filter(d => 
                d.æ“ä½œå‘˜ID === row.æ“ä½œå‘˜ID && 
                d.æ“ä½œæ—¶é—´.toDateString() === row.æ“ä½œæ—¶é—´.toDateString()
            );
            
            const dailyFrequency = sameDayOperations.length;
            
            // ç®€å•é˜ˆå€¼æ£€æµ‹
            if (dailyFrequency > 20) {
                return Math.min(1.0, (dailyFrequency - 20) / 10);
            }
            
            return 0.0;
        }

        function detectSpecialPatterns(row, data) {
            let boost = 0.0;
            
            // å¤œé—´é«˜æµé‡æ£€æµ‹
            const hour = row.æ“ä½œæ—¶é—´.getHours();
            if (hour >= 22 || hour <= 6) {
                const nightOperations = data.filter(d => {
                    const h = d.æ“ä½œæ—¶é—´.getHours();
                    return (h >= 22 || h <= 6) && 
                           d.æ“ä½œæ—¶é—´.toDateString() === row.æ“ä½œæ—¶é—´.toDateString();
                });
                
                if (nightOperations.length > 5) {
                    boost += 0.3;
                }
            }
            
            // å›½é™…æ¼«æ¸¸çªå¢æ£€æµ‹
            if (row.ä¸šåŠ¡ç±»å‹ === 'å›½é™…æ¼«æ¸¸') {
                const weekAgo = new Date(row.æ“ä½œæ—¶é—´.getTime() - 7 * 24 * 60 * 60 * 1000);
                const recentRoaming = data.filter(d => 
                    d.ä¸šåŠ¡ç±»å‹ === 'å›½é™…æ¼«æ¸¸' && 
                    d.æ“ä½œæ—¶é—´ >= weekAgo && 
                    d.æ“ä½œæ—¶é—´ <= row.æ“ä½œæ—¶é—´
                );
                
                if (recentRoaming.length > 3) {
                    boost += 0.5;
                }
            }
            
            return boost;
        }

        function analyzeTimePatterns(data) {
            const hourlyCounts = {};
            for (let i = 0; i < 24; i++) {
                hourlyCounts[i] = 0;
            }
            
            data.forEach(row => {
                const hour = row.æ“ä½œæ—¶é—´.getHours();
                hourlyCounts[hour]++;
            });
            
            return hourlyCounts;
        }

        function generateVisualizations(data, riskScores) {
            // æ—¶é—´è½´å›¾
            const timelineData = data.map(row => ({
                time: row.æ“ä½œæ—¶é—´,
                amount: row.è´¹ç”¨é‡‘é¢,
                risk: riskScores[String(row.è´¦å•ç¼–å·)] || 0,
                billId: row.è´¦å•ç¼–å·
            })).sort((a, b) => a.time - b.time);

            const timelineTrace = {
                x: timelineData.map(d => d.time),
                y: timelineData.map(d => d.amount),
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 8,
                    color: timelineData.map(d => d.risk),
                    colorscale: 'RdYlGn_r',
                    showscale: true,
                    colorbar: { title: "é£é™©è¯„åˆ†" }
                },
                text: timelineData.map(d => `è´¦å•: ${d.billId}<br>é‡‘é¢: ${d.amount}<br>é£é™©: ${d.risk.toFixed(3)}`),
                hoverinfo: 'text'
            };

            const timelineLayout = {
                title: 'è´¹ç”¨é‡‘é¢æ—¶é—´è½´ (é¢œè‰²è¡¨ç¤ºé£é™©è¯„åˆ†)',
                xaxis: { title: 'æ—¶é—´' },
                yaxis: { title: 'è´¹ç”¨é‡‘é¢ (å…ƒ)' },
                height: 400
            };

            Plotly.newPlot('timelineChart', [timelineTrace], timelineLayout);

            // é£é™©åˆ†å¸ƒå›¾
            const riskValues = Object.values(riskScores);
            const riskTrace = {
                x: riskValues,
                type: 'histogram',
                nbinsx: 20,
                marker: { color: 'lightblue', opacity: 0.7 }
            };

            const riskLayout = {
                title: 'é£é™©è¯„åˆ†åˆ†å¸ƒ',
                xaxis: { title: 'é£é™©è¯„åˆ†' },
                yaxis: { title: 'é¢‘æ¬¡' },
                shapes: [
                    { type: 'line', x0: 0.3, x1: 0.3, y0: 0, y1: 1, yref: 'paper', 
                      line: { dash: 'dash', color: 'orange' } },
                    { type: 'line', x0: 0.7, x1: 0.7, y0: 0, y1: 1, yref: 'paper', 
                      line: { dash: 'dash', color: 'red' } }
                ],
                annotations: [
                    { x: 0.3, y: 0.9, yref: 'paper', text: 'ä½é£é™©é˜ˆå€¼', showarrow: false },
                    { x: 0.7, y: 0.9, yref: 'paper', text: 'é«˜é£é™©é˜ˆå€¼', showarrow: false }
                ]
            };

            Plotly.newPlot('riskDistributionChart', [riskTrace], riskLayout);

            // æ“ä½œå‘˜åˆ†æå›¾
            const operatorStats = {};
            data.forEach(row => {
                const operatorId = row.æ“ä½œå‘˜ID;
                const risk = riskScores[String(row.è´¦å•ç¼–å·)] || 0;
                
                if (!operatorStats[operatorId]) {
                    operatorStats[operatorId] = { risks: [], count: 0 };
                }
                operatorStats[operatorId].risks.push(risk);
                operatorStats[operatorId].count++;
            });

            const operatorTrace = {
                x: Object.values(operatorStats).map(s => s.count),
                y: Object.values(operatorStats).map(s => s.risks.reduce((a, b) => a + b, 0) / s.risks.length),
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: Object.values(operatorStats).map(s => Math.max(10, s.count / 2)),
                    color: Object.values(operatorStats).map(s => s.risks.reduce((a, b) => a + b, 0) / s.risks.length),
                    colorscale: 'RdYlGn_r',
                    showscale: true,
                    colorbar: { title: "å¹³å‡é£é™©è¯„åˆ†" }
                },
                text: Object.keys(operatorStats),
                hoverinfo: 'text+x+y'
            };

            const operatorLayout = {
                title: 'æ“ä½œå‘˜é£é™©åˆ†æ',
                xaxis: { title: 'æ“ä½œæ¬¡æ•°' },
                yaxis: { title: 'å¹³å‡é£é™©è¯„åˆ†' },
                height: 400
            };

            Plotly.newPlot('operatorChart', [operatorTrace], operatorLayout);
        }

        function showResults(data, riskScores) {
            const riskValues = Object.values(riskScores);
            const highRiskCount = riskValues.filter(v => v >= 0.7).length;
            const mediumRiskCount = riskValues.filter(v => v >= 0.3 && v < 0.7).length;
            const lowRiskCount = riskValues.filter(v => v < 0.3).length;
            const avgRisk = riskValues.reduce((a, b) => a + b, 0) / riskValues.length;

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.length}</div>
                    <div class="stat-label">æ€»è®°å½•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${highRiskCount}</div>
                    <div class="stat-label">é«˜é£é™©è®°å½•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${mediumRiskCount}</div>
                    <div class="stat-label">ä¸­é£é™©è®°å½•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${avgRisk.toFixed(3)}</div>
                    <div class="stat-label">å¹³å‡é£é™©è¯„åˆ†</div>
                </div>
            `;

            // ç”Ÿæˆé£é™©è¡¨æ ¼
            const highRiskRecords = Object.entries(riskScores)
                .filter(([_, score]) => score >= 0.7)
                .sort(([_, a], [__, b]) => b - a)
                .slice(0, 20);

            const tableHtml = `
                <table class="risk-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>è´¦å•ç¼–å·</th>
                            <th>é£é™©è¯„åˆ†</th>
                            <th>é£é™©ç­‰çº§</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${highRiskRecords.map(([billId, score], index) => {
                            const riskLevel = score >= 0.7 ? 'é«˜é£é™©' : score >= 0.3 ? 'ä¸­é£é™©' : 'ä½é£é™©';
                            const rowClass = score >= 0.7 ? 'high-risk' : score >= 0.3 ? 'medium-risk' : 'low-risk';
                            return `
                                <tr class="${rowClass}">
                                    <td>${index + 1}</td>
                                    <td>${billId}</td>
                                    <td>${score.toFixed(3)}</td>
                                    <td>${riskLevel}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('riskTable').innerHTML = tableHtml;
            document.getElementById('resultsSection').style.display = 'block';
        }

        function exportReport() {
            if (!currentData || !riskScores) {
                showError('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }

            // åˆ›å»ºæŠ¥å‘Šæ•°æ®
            const reportData = currentData.map(row => ({
                ...row,
                é£é™©è¯„åˆ†: riskScores[String(row.è´¦å•ç¼–å·)] || 0,
                é£é™©ç­‰çº§: (() => {
                    const score = riskScores[String(row.è´¦å•ç¼–å·)] || 0;
                    return score >= 0.7 ? 'é«˜é£é™©' : score >= 0.3 ? 'ä¸­é£é™©' : 'ä½é£é™©';
                })()
            }));

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(reportData);
            XLSX.utils.book_append_sheet(wb, ws, "å¼‚å¸¸æ£€æµ‹ç»“æœ");

            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(wb, `èµ„è´¹å¼‚å¸¸æ£€æµ‹æŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.xlsx`);
            showSuccess('æŠ¥å‘Šå·²å¯¼å‡º');
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.upload-section').appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.upload-section').appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 5000);
        }

        function generateAndDetectSample() {
            // ç”Ÿæˆ100æ¡æ¨¡æ‹Ÿè´¦å•æ•°æ®ï¼Œä½:ä¸­:é«˜é£é™©æ¯”ä¾‹çº¦7:2:1ï¼Œå¹¶å¢åŠ "é«˜/ä¸­é£é™©æ ‡è®°"å­—æ®µ
            const businessTypes = [
                ["å¼€æˆ·", [100, 200]],
                ["é”€æˆ·", [50, 100]],
                ["å¥—é¤å˜æ›´", [100, 500]],
                ["å……å€¼", [10, 1000]],
                ["æµé‡åŒ…", [5, 200]],
                ["å›½é™…æ¼«æ¸¸", [100, 2000]]
            ];
            const operatorIds = ["OP001", "OP002", "OP003"];
            const branchIds = ["BR001", "BR002", "BR003"];
            const rows = [];
            const baseTime = new Date(2024, 0, 15, 8, 0, 0);
            const total = 100;
            const highCount = Math.round(total * 0.1);   // 10æ¡é«˜é£é™©
            const mediumCount = Math.round(total * 0.2); // 20æ¡ä¸­é£é™©
            const lowCount = total - highCount - mediumCount; // 70æ¡ä½é£é™©
            let idx = 0;
            // å…ˆç”Ÿæˆé«˜é£é™©
            for (let i = 0; i < highCount; i++, idx++) {
                const [btype, [amin, amax]] = businessTypes[Math.floor(Math.random() * businessTypes.length)];
                let amount = +(Math.random() * 5000 + 3000).toFixed(2);
                let discount = +(Math.random() * amount * 0.2).toFixed(2);
                let realAmount = +(amount - discount).toFixed(2);
                const opId = operatorIds[Math.floor(Math.random() * operatorIds.length)];
                const brId = branchIds[Math.floor(Math.random() * branchIds.length)];
                const date = new Date(baseTime.getTime() + Math.floor(idx / 15) * 24 * 3600 * 1000);
                let hour = [0, 1, 2, 3, 4, 23][Math.floor(Math.random() * 6)];
                let minute = Math.floor(Math.random() * 60);
                const timeStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')} ${hour.toString().padStart(2,'0')}:${minute.toString().padStart(2,'0')}:00`;
                rows.push({
                    "è´¦å•ç¼–å·": `BILL${(idx+1).toString().padStart(3,'0')}`,
                    "è¥ä¸šå…ç¼–å·": brId,
                    "è´¦å•æ—¥æœŸ": `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`,
                    "æ“ä½œå‘˜ID": opId,
                    "ä¸šåŠ¡ç±»å‹": btype,
                    "è´¹ç”¨é‡‘é¢": amount,
                    "ä¼˜æƒ é‡‘é¢": discount,
                    "å®æ”¶é‡‘é¢": realAmount,
                    "æ“ä½œæ—¶é—´": timeStr,
                    "é«˜é£é™©æ ‡è®°": "æ˜¯",
                    "ä¸­é£é™©æ ‡è®°": "å¦"
                });
            }
            // å†ç”Ÿæˆä¸­é£é™©
            for (let i = 0; i < mediumCount; i++, idx++) {
                const [btype, [amin, amax]] = businessTypes[Math.floor(Math.random() * businessTypes.length)];
                let amount = +(Math.random() * (amax * 2 - amin) + amin).toFixed(2); // é€‚åº¦åé«˜
                let discount = +(Math.random() * amount * 0.2).toFixed(2);
                let realAmount = +(amount - discount).toFixed(2);
                const opId = operatorIds[Math.floor(Math.random() * operatorIds.length)];
                const brId = branchIds[Math.floor(Math.random() * branchIds.length)];
                const date = new Date(baseTime.getTime() + Math.floor(idx / 15) * 24 * 3600 * 1000);
                let hour = [6, 7, 8, 21, 22][Math.floor(Math.random() * 5)]; // è¥ä¸šè¾¹ç¼˜æ—¶æ®µ
                let minute = Math.floor(Math.random() * 60);
                const timeStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')} ${hour.toString().padStart(2,'0')}:${minute.toString().padStart(2,'0')}:00`;
                rows.push({
                    "è´¦å•ç¼–å·": `BILL${(idx+1).toString().padStart(3,'0')}`,
                    "è¥ä¸šå…ç¼–å·": brId,
                    "è´¦å•æ—¥æœŸ": `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`,
                    "æ“ä½œå‘˜ID": opId,
                    "ä¸šåŠ¡ç±»å‹": btype,
                    "è´¹ç”¨é‡‘é¢": amount,
                    "ä¼˜æƒ é‡‘é¢": discount,
                    "å®æ”¶é‡‘é¢": realAmount,
                    "æ“ä½œæ—¶é—´": timeStr,
                    "é«˜é£é™©æ ‡è®°": "å¦",
                    "ä¸­é£é™©æ ‡è®°": "æ˜¯"
                });
            }
            // æœ€åç”Ÿæˆä½é£é™©
            for (let i = 0; i < lowCount; i++, idx++) {
                const [btype, [amin, amax]] = businessTypes[Math.floor(Math.random() * businessTypes.length)];
                let amount = +(Math.random() * (amax - amin) + amin).toFixed(2);
                let discount = +(Math.random() * amount * 0.2).toFixed(2);
                let realAmount = +(amount - discount).toFixed(2);
                const opId = operatorIds[Math.floor(Math.random() * operatorIds.length)];
                const brId = branchIds[Math.floor(Math.random() * branchIds.length)];
                const date = new Date(baseTime.getTime() + Math.floor(idx / 15) * 24 * 3600 * 1000);
                let hour = Math.floor(Math.random() * 12) + 8; // æ­£å¸¸è¥ä¸šæ—¶æ®µ
                let minute = Math.floor(Math.random() * 60);
                const timeStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')} ${hour.toString().padStart(2,'0')}:${minute.toString().padStart(2,'0')}:00`;
                rows.push({
                    "è´¦å•ç¼–å·": `BILL${(idx+1).toString().padStart(3,'0')}`,
                    "è¥ä¸šå…ç¼–å·": brId,
                    "è´¦å•æ—¥æœŸ": `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`,
                    "æ“ä½œå‘˜ID": opId,
                    "ä¸šåŠ¡ç±»å‹": btype,
                    "è´¹ç”¨é‡‘é¢": amount,
                    "ä¼˜æƒ é‡‘é¢": discount,
                    "å®æ”¶é‡‘é¢": realAmount,
                    "æ“ä½œæ—¶é—´": timeStr,
                    "é«˜é£é™©æ ‡è®°": "å¦",
                    "ä¸­é£é™©æ ‡è®°": "å¦"
                });
            }
            currentData = rows;
            showSuccess('å·²ç”Ÿæˆ100æ¡æ¨¡æ‹Ÿè´¦å•æ•°æ®ï¼ˆä½:ä¸­:é«˜ â‰ˆ 7:2:1ï¼‰');
            document.getElementById('detectBtn').disabled = false;
            detectAnomalies();
        }
    </script>
</body>
</html> 